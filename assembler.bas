10 CLEAR 2000
15 DIM MN$(120),OC(120)
16 NOP=0
17 READ A$
18 IF A$="ENDOP" THEN 25
19 NOP=NOP+1:MN$(NOP)=A$:READ OC(NOP):GOTO 17
25 ' opcode table loaded

30 DIM SS$(250),LB$(100),LA(100)
40 PRINT "6809 MINI ASSEMBLER (DATA MODE)"
50 INPUT "START ADDRESS";SA
60 PC=SA:LN=0

REM ===== READ SOURCE FROM DATA =====
70 READ L$
80 IF L$="END" THEN 90
90 SS$(LN+1)=L$
100 LN=LN+1
110 GOTO 70

REM ===== FIRST PASS =====
200 NL=0:TP=SA
210 FOR I=1 TO LN
220 A$=SS$(I)
230 WHILE LEN(A$)>0 AND LEFT$(A$,1)=" ":A$=MID$(A$,2):WEND
240 P=INSTR(A$,":")
250 IF P>0 THEN LBL$=LEFT$(A$,P-1):NL=NL+1:LB$(NL)=LBL$:A$=MID$(A$,P+1)
260 WHILE LEN(A$)>0 AND LEFT$(A$,1)=" ":A$=MID$(A$,2):WEND
270 IF A$="" THEN 330

280 OP$=LEFT$(A$,3)
290 GOSUB 1000:IF OP<0 THEN 330

REM ===== SECOND PASS =====
210 PC=SA
220 FOR I=1 TO LN
230 A$=SS$(I)
240 WHILE LEN(A$)>0 AND LEFT$(A$,1)=" ":A$=MID$(A$,2):WEND
250 P=INSTR(A$,":"):IF P>0 THEN A$=MID$(A$,P+1)
260 WHILE LEN(A$)>0 AND LEFT$(A$,1)=" ":A$=MID$(A$,2):WEND
270 IF A$="" THEN 350

280 OP$=LEFT$(A$,3):GOSUB 1000:IF OP<0 THEN PRINT "BAD MNEMONIC ";A$:GOTO 350
290 IF LEN(A$)>=5 THEN AR$=MID$(A$,5) ELSE AR$=""

300 T=GOSUB 1100
310 ON T GOSUB 1200,1300,1400,1500,1600

350 NEXT I

360 PRINT "ASSEMBLED TO ";PC-1
370 PRINT "EXEC ";SA
380 END

REM ===== OPCODE LOOKUP =====
1000 OP=-1
1010 FOR J=1 TO NOP
1020 IF MN$(J)=OP$ THEN OP=OC(J):RETURN
1030 NEXT J
1040 RETURN

REM ===== OPCODE TYPE CLASSIFIER =====
1100 ' 0=inherent, 1=imm, 2=ext, 3=branch, 4=indexed
1110 IF OP=57 OR OP=76 OR OP=92 OR OP=74 OR OP=90 THEN RETURN 0
1120 IF OP=134 OR OP=198 OR OP=139 OR OP=203 OR OP=128 OR OP=192 OR OP=132 OR OP=196 OR OP=138 OR OP=202 OR OP=133 OR OP=197 THEN RETURN 1
1130 IF OP=183 OR OP=247 OR OP=189 OR OP=126 THEN RETURN 2
1140 IF OP>=32 AND OP<=41 THEN RETURN 3
1150 IF OP=166 OR OP=230 OR OP=167 OR OP=231 THEN RETURN 4
1160 RETURN -1

REM ===== EMIT INHERENT =====
1200 POKE PC,OP:PC=PC+1:RETURN

REM ===== IMMEDIATE (#) =====
1300 GOSUB 1700
1310 POKE PC,OP:POKE PC+1,VA:PC=PC+2:RETURN

REM ===== EXTENDED =====
1400 GOSUB 1710
1410 POKE PC,OP
1420 POKE PC+1,INT(VA/256)
1430 POKE PC+2,VA AND 255
1440 PC=PC+3:RETURN

REM ===== RELATIVE BRANCH =====
1500 GOSUB 1710
1510 OF=VA-(PC+2)
1520 IF OF<-128 OR OF>127 THEN PRINT "?BRANCH RANGE":OF=0
1530 IF OF<0 THEN OF=OF+256
1540 POKE PC,OP:POKE PC+1,OF
1550 PC=PC+2:RETURN

REM ===== INDEXED =====
1600 GOSUB 1710
1610 POKE PC,OP
1620 POKE PC+1,VA AND 255
1630 PC=PC+2:RETURN

REM ===== PARSE OPERANDS =====
1700 B$=AR$
1710 IF B$="" THEN VA=0:RETURN
1720 IF LEFT$(B$,1)="#" THEN B$=MID$(B$,2)
1730 GOSUB 1800:RETURN

REM ===== LABEL/HEX/DEC PARSER =====
1800 IF LEFT$(B$,1)="$" THEN HX$=MID$(B$,2):GOSUB 1900:RETURN
1810 FOR Z=1 TO NL:IF B$=LB$(Z) THEN VA=LA(Z):RETURN
1820 NEXT Z
1830 VA=VAL(B$):RETURN

REM ===== HEX PARSER =====
1900 VA=0
1910 FOR K=1 TO LEN(HX$)
1920 C=ASC(MID$(HX$,K,1))
1930 IF C>=48 AND C<=57 THEN D=C-48:GOTO 1950
1940 IF C>=65 AND C<=70 THEN D=C-55:GOTO 1950
1945 IF C>=97 AND C<=102 THEN D=C-87:GOTO 1950
1948 D=0
1950 VA=VA*16+D
1960 NEXT K
1970 RETURN

REM ===== OPCODE DATA TABLE =====
3000 DATA INA,&H4C,INB,&H5C,DEA,&H4A,DEB,&H5A
3010 DATA ADA,&H8B,ADB,&HCB,SUA,&H80,SUB,&HC0
3020 DATA ANA,&H84,ANB,&HC4,ORA,&H8A,ORB,&HCA
3030 DATA BIA,&H85,BIB,&HC5
3040 DATA LDA,&H86,LDB,&HC6
3050 DATA STA,&HB7,STB,&HF7,JSR,&HBD,JMP,&H7E
3060 DATA BRA,&H20,BEQ,&H27,BNE,&H26
3070 DATA BMI,&H2B,BPL,&H2A,BHI,&H22,BLS,&H23
3080 DATA BHS,&H24,BLO,&H25,BVC,&H28,BVS,&H29
3090 DATA LAX,&HA6,LBX,&HE6,SAX,&HA7,SBX,&HE7
3100 DATA RTS,&H39
3110 DATA ENDOP

4000 DATA "START: LDX $0400
4001 DATA "STA 0,X
4002 DATA LDA #65
4003 DATA "STA 1,X
4004 DATA RTS
4005 DATA END
